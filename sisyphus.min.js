/**
 * Plugin developed to save html forms data to LocalStorage to restore them after browser crashes, tabs closings
 * and other disasters.
 *
 * https://github.com/simsalabim/sisyphus
 *
 * @author Alexander Kaupanin <kaupanin@gmail.com>
 * @license MIT - see https://github.com/simsalabim/sisyphus/blob/master/MIT-LICENSE
 */
(function(u){function c(e){return"[id="+e.attr("id")+"][name="+e.attr("name")+"]"}u.fn.sisyphus=function(e){var t=u.map(this,function(e){return c(u(e))}).join();var i=Sisyphus.getInstance(t);i.protect(this,e);return i};var i={};i.isAvailable=function(){if(typeof u.jStorage==="object"){return true}try{return localStorage.getItem}catch(e){return false}};i.set=function(e,t){if(typeof u.jStorage==="object"){u.jStorage.set(e,t+"")}else{try{localStorage.setItem(e,t+"")}catch(e){}}};i.get=function(e){if(typeof u.jStorage==="object"){var t=u.jStorage.get(e);return t?t.toString():t}else{return localStorage.getItem(e)}};i.remove=function(e){if(typeof u.jStorage==="object"){u.jStorage.deleteKey(e)}else{localStorage.removeItem(e)}};Sisyphus=function(){var s={instantiated:[],started:[]};var f=window.CKEDITOR;function t(){return{setInstanceIdentifier:function(e){this.identifier=e},getInstanceIdentifier:function(){return this.identifier},setInitialOptions:function(e){var t={excludeFields:[],customKeySuffix:"",locationBased:false,timeout:0,autoRelease:true,onBeforeSave:function(){},onSave:function(){},onBeforeRestore:function(){},onRestore:function(){},onRelease:function(){}};this.options=this.options||u.extend(t,e);this.browserStorage=i},setOptions:function(e){this.options=this.options||this.setInitialOptions(e);this.options=u.extend(this.options,e)},protect:function(e,t){this.setOptions(t);e=e||{};var i=this;this.targets=this.targets||[];if(i.options.name){this.href=i.options.name}else{this.href=location.hostname+location.pathname+location.search+location.hash}this.targets=u.merge(this.targets,e);this.targets=u.unique(this.targets);this.targets=u(this.targets);if(!this.browserStorage.isAvailable()){return false}var n=i.options.onBeforeRestore.call(i);if(n===undefined||n){i.restoreAllData()}if(this.options.autoRelease){i.bindReleaseData()}if(!s.started[this.getInstanceIdentifier()]){if(i.isCKEditorPresent()){var a=setInterval(function(){if(f.isLoaded){clearInterval(a);i.bindSaveData();s.started[i.getInstanceIdentifier()]=true}},100)}else{i.bindSaveData();s.started[i.getInstanceIdentifier()]=true}}},isCKEditorPresent:function(){if(this.isCKEditorExists()){f.isLoaded=false;f.on("instanceReady",function(){f.isLoaded=true});return true}else{return false}},isCKEditorExists:function(){return typeof f!=="undefined"},findFieldsToProtect:function(e){return e.find(":input").not(":submit").not(":reset").not(":button").not(":file").not(":password").not(":disabled").not("[readonly]")},bindSaveData:function(){var n=this;if(n.options.timeout){n.saveDataByTimeout()}n.targets.each(function(){var i=c(u(this));n.findFieldsToProtect(u(this)).each(function(){if(u.inArray(this,n.options.excludeFields)!==-1){return true}var e=u(this);var t=(n.options.locationBased?n.href:"")+i+c(e)+n.options.customKeySuffix;if(e.is(":text")||e.is("textarea")){if(!n.options.timeout){n.bindSaveDataImmediately(e,t)}}n.bindSaveDataOnChange(e)})})},saveAllData:function(){var r=this;r.targets.each(function(){var s=c(u(this));var o={};r.findFieldsToProtect(u(this)).each(function(){var e=u(this);if(u.inArray(this,r.options.excludeFields)!==-1||e.attr("name")===undefined&&e.attr("id")===undefined){return true}var t=(r.options.locationBased?r.href:"")+s+c(e)+r.options.customKeySuffix;var i=e.val();if(e.is(":checkbox")){var n=e.attr("name");if(n!==undefined&&n.indexOf("[")!==-1){if(o[n]===true){return}i=[];u("[name='"+n+"']:checked").each(function(){i.push(u(this).val())});o[n]=true}else{i=e.is(":checked")}r.saveToBrowserStorage(t,i,false)}else if(e.is(":radio")){if(e.is(":checked")){i=e.val();r.saveToBrowserStorage(t,i,false)}else{r.browserStorage.remove(t)}}else{if(r.isCKEditorExists()){var a=f.instances[e.attr("name")]||f.instances[e.attr("id")];if(a){a.updateElement();r.saveToBrowserStorage(t,e.val(),false)}else{r.saveToBrowserStorage(t,i,false)}}else{r.saveToBrowserStorage(t,i,false)}}})});r.options.onSave.call(r)},restoreAllData:function(){var a=this;var s=false;a.targets.each(function(){var e=u(this);var n=c(u(this));a.findFieldsToProtect(e).each(function(){if(u.inArray(this,a.options.excludeFields)!==-1){return true}var e=u(this);var t=(a.options.locationBased?a.href:"")+n+c(e)+a.options.customKeySuffix;var i=a.browserStorage.get(t);if(i!==null){a.restoreFieldsData(e,i);s=true}})});if(s){a.options.onRestore.call(a)}},restoreFieldsData:function(e,t){if(e.attr("name")===undefined&&e.attr("id")===undefined){return false}var i=e.attr("name");if(e.is(":checkbox")&&t!=="false"&&(i===undefined||i.indexOf("[")===-1)){e.prop("checked",true)}else if(e.is(":checkbox")&&t==="false"&&(i===undefined||i.indexOf("[")===-1)){e.prop("checked",false)}else if(e.is(":radio")){if(e.val()===t){e.prop("checked",true)}}else if(i===undefined||i.indexOf("[")===-1){e.val(t)}else{t=t.split(",");e.val(t)}},bindSaveDataImmediately:function(e,t){var i=this;if("onpropertychange"in e){e.get(0).onpropertychange=function(){i.saveToBrowserStorage(t,e.val())}}else{e.get(0).oninput=function(){i.saveToBrowserStorage(t,e.val())}}if(this.isCKEditorExists()){var n=f.instances[e.attr("name")]||f.instances[e.attr("id")];if(n){n.document.on("keyup",function(){n.updateElement();i.saveToBrowserStorage(t,e.val())})}}},saveToBrowserStorage:function(e,t,i){var n=this;var a=n.options.onBeforeSave.call(n);if(a!==undefined&&a===false){return}i=i===undefined?true:i;this.browserStorage.set(e,t);if(i&&t!==""){this.options.onSave.call(this)}},bindSaveDataOnChange:function(e){var t=this;e.change(function(){t.saveAllData()})},saveDataByTimeout:function(){var t=this;var e=t.targets;setTimeout(function(){function e(){t.saveAllData();setTimeout(e,t.options.timeout*1e3)}return e}(e),t.options.timeout*1e3)},bindReleaseData:function(){var i=this;i.targets.each(function(){var e=u(this);var t=c(e);u(this).bind("submit reset",function(){i.releaseData(t,i.findFieldsToProtect(e))})})},manuallyReleaseData:function(){var i=this;i.targets.each(function(){var e=u(this);var t=c(e);i.releaseData(t,i.findFieldsToProtect(e))})},releaseData:function(i,e){var n=false;var a=this;s.started[a.getInstanceIdentifier()]=false;e.each(function(){if(u.inArray(this,a.options.excludeFields)!==-1){return true}var e=u(this);var t=(a.options.locationBased?a.href:"")+i+c(e)+a.options.customKeySuffix;a.browserStorage.remove(t);n=true});if(n){a.options.onRelease.call(a)}}}}return{getInstance:function(e){if(!s.instantiated[e]){s.instantiated[e]=t();s.instantiated[e].setInstanceIdentifier(e);s.instantiated[e].setInitialOptions()}if(e){return s.instantiated[e]}return s.instantiated[e]},free:function(){s={instantiated:[],started:[]};return null},version:"1.1.3"}}()})(jQuery);
